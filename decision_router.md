# 投资决策路由 (Decision Router)

> 根据你的问题类型，快速定位该参考哪位投资大师。

---

## 一、选股决策

### 1.1 护城河评估
**问题**：这家公司有护城河吗？竞争优势能持续吗？

| 优先参考 | 次要参考 | 核心问题 |
|----------|----------|----------|
| Warren Buffett | Seth Klarman | 品牌/网络/成本/转换成本？ |
| Charlie Munger | | 护城河是真的还是伪护城河？ |

**决策规则**：
- IF 无法识别明确护城河 THEN 不买 BECAUSE 无竞争优势
- IF 护城河依赖单一因素（如专利到期）THEN 谨慎 BECAUSE 可能是暂时性

---

### 1.2 成长股估值
**问题**：这个成长股贵不贵？值得买吗？

| 优先参考 | 次要参考 | 核心问题 |
|----------|----------|----------|
| Peter Lynch | Warren Buffett | PEG < 1？增速可持续？ |

**决策规则**：
- IF PEG < 0.5 AND 增速可持续 THEN 机会 BECAUSE 成长被低估
- IF PEG > 2 THEN 高估 BECAUSE 为成长付太多溢价
- IF 增速依赖单一产品/市场 THEN 谨慎 BECAUSE 成长可能不持续

---

### 1.3 深度价值/冷门
**问题**：这个便宜的股票是机会还是陷阱？

| 优先参考 | 次要参考 | 核心问题 |
|----------|----------|----------|
| Seth Klarman | Howard Marks | 为何便宜？卖压是结构性还是暂时性？ |
| Michael Burry | | 清算价值是多少？ |

**决策规则**：
- IF 便宜因为被动抛售（指数调整）AND 基本面未变 THEN 机会 BECAUSE 非理性卖压
- IF 便宜因为行业结构性衰退 THEN 不买 BECAUSE 价值陷阱
- IF 清算价值 > 市值 AND 有催化剂 THEN 深入研究 BECAUSE 极端安全边际

---

### 1.4 价值陷阱排除
**问题**：如何避免买到价值陷阱？

| 优先参考 | 次要参考 | 核心问题 |
|----------|----------|----------|
| Charlie Munger | Warren Buffett | 便宜的原因会持续恶化吗？ |
| | Seth Klarman | |

**决策规则**：
- IF 护城河被侵蚀 AND 无改善迹象 THEN 价值陷阱 BECAUSE 便宜会更便宜
- IF 管理层问题 AND 无更换可能 THEN 价值陷阱 BECAUSE 无改变催化剂
- IF 行业结构性衰退（如报纸）THEN 价值陷阱 BECAUSE 趋势不可逆

---

## 二、宏观/择时

### 2.1 经济周期定位
**问题**：现在经济在周期的哪个位置？该进攻还是防守？

| 优先参考 | 次要参考 | 核心问题 |
|----------|----------|----------|
| Ray Dalio | Howard Marks | 增长↑↓？通膨↑↓？ |
| | Stanley Druckenmiller | 处于四象限的哪里？ |

**决策规则**：
- IF 增长↑ + 通膨↓ THEN 做多股票、公司债 BECAUSE 温和扩张最佳环境
- IF 增长↓ + 通膨↑ THEN 持有商品、黄金、TIPS BECAUSE 滞胀保护
- IF 增长↓ + 通膨↓ THEN 持有长期国债、现金 BECAUSE 衰退/通缩环境

---

### 2.2 流动性趋势
**问题**：流动性在扩张还是收缩？对市场有什么影响？

| 优先参考 | 次要参考 | 核心问题 |
|----------|----------|----------|
| Stanley Druckenmiller | Ray Dalio | Fed B/S、TGA、RRP 方向？ |

**决策规则**：
- IF 净流动性（Fed B/S − TGA − RRP）上升 THEN 做多风险资产 BECAUSE 流动性推动市场
- IF 净流动性下降 AND 高估值 THEN 减仓 BECAUSE 双杀风险
- IF Fed 政策转向（紧→松）THEN 先布局成长股 BECAUSE 流动性改善先反映在股市

---

### 2.3 货币/汇率机会
**问题**：有货币交易机会吗？汇率有失衡吗？

| 优先参考 | 次要参考 | 核心问题 |
|----------|----------|----------|
| George Soros | Stanley Druckenmiller | 政策/汇率是否不可持续？ |

**决策规则**：
- IF 固定汇率制 AND 外储耗竭 AND 经济失衡 THEN 货币脱钩机会 BECAUSE Soros 经典交易
- IF 反身性自我强化阶段 THEN 顺势交易 BECAUSE 趋势会超预期
- IF 政策空间耗尽 THEN 等待崩溃 BECAUSE 不可持续必将结束

---

### 2.4 利率转向
**问题**：Fed 要转向了吗？该如何调整？

| 优先参考 | 次要参考 | 核心问题 |
|----------|----------|----------|
| Stanley Druckenmiller | Ray Dalio | 加息结束/降息开始的信号？ |
| | Howard Marks | |

**决策规则**：
- IF 最后一次加息确认 THEN 做多长期国债 BECAUSE 历史规律
- IF 预防性降息（非衰退）THEN 做多成长股 BECAUSE 估值扩张
- IF 衰退式降息 THEN 防守优先 BECAUSE 盈利会下滑

---

## 三、风险检查

### 3.1 心理偏误检查
**问题**：我的决策有偏误吗？

| 优先参考 | 核心问题 |
|----------|----------|
| Charlie Munger | 有确认偏误吗？有FOMO吗？有过度自信吗？ |

**决策规则**：
- IF 只看利好信息 THEN 确认偏误 BECAUSE 需要主动找反驳论点
- IF "大家都在买" THEN 从众效应 BECAUSE 需要独立思考
- IF "我比市场聪明" THEN 过度自信 BECAUSE 市场可能知道你不知道的
- IF "已经买了不能认错" THEN 承诺一致性 BECAUSE 论点错了就该走

---

### 3.2 周期位置判断
**问题**：市场情绪在哪个极端？该贪婪还是恐惧？

| 优先参考 | 次要参考 | 核心问题 |
|----------|----------|----------|
| Howard Marks | Ray Dalio | 恐惧 vs 贪婪？信用周期在哪？ |

**决策规则**：
- IF 恐慌抛售 + 估值极低 + 信用冻结 THEN 底部接近 BECAUSE 极端后必回归
- IF 杠杆激增 + 散户涌入 + 低质资产热捧 THEN 顶部接近 BECAUSE 周期过热
- IF 「这次不一样」成为共识 THEN 警惕 BECAUSE 周期规律不变

---

### 3.3 极端风险/泡沫识别
**问题**：这是泡沫吗？会崩盘吗？

| 优先参考 | 次要参考 | 核心问题 |
|----------|----------|----------|
| Michael Burry | Howard Marks | 共识错在哪？数据被忽略了吗？ |
| Charlie Munger | George Soros | |

**决策规则**：
- IF 估值需要「信仰」才能合理化 THEN 泡沫风险 BECAUSE 基本面无法支撑
- IF 新指标取代传统估值（如用户数代替盈利）THEN 泡沫信号 BECAUSE 历史重演
- IF 股神已老/价值投资已死成为共识 THEN 泡沫信号 BECAUSE 经典逆向指标

---

### 3.4 止损决策
**问题**：该认错止损吗？

| 优先参考 | 次要参考 | 核心问题 |
|----------|----------|----------|
| George Soros | Stanley Druckenmiller | 论点还成立吗？ |

**决策规则**：
- IF 买入论点不再成立 THEN 立即止损 BECAUSE 错了就跑
- IF 基本面恶化（非价格下跌）THEN 卖出 BECAUSE 情况在变坏
- IF 有更好的机会 THEN 换仓 BECAUSE 机会成本

---

## 四、组合配置

### 4.1 资产配置
**问题**：该如何配置股/债/商品/现金？

| 优先参考 | 次要参考 | 核心问题 |
|----------|----------|----------|
| Ray Dalio | Howard Marks | 经济象限？各资产风险贡献？ |

**决策规则**：
- IF 增长↑ + 通膨↓ THEN 偏重股票 BECAUSE 最佳环境
- IF 增长↓ + 通膨↑ THEN 偏重商品、黄金 BECAUSE 滞胀保护
- IF 不确定 THEN 全天候配置 BECAUSE 分散风险

---

### 4.2 现金比例
**问题**：该持有多少现金？

| 优先参考 | 次要参考 | 核心问题 |
|----------|----------|----------|
| Seth Klarman | Howard Marks | 机会够好吗？还是该等待？ |
| | Warren Buffett | |

**决策规则**：
- IF 估值普遍高估 AND 缺乏安全边际 THEN 提高现金 BECAUSE 等待更好机会
- IF 恐慌抛售 AND 优质资产便宜 THEN 减少现金 BECAUSE 机会窗口
- IF 不确定 THEN 保持 20-30% 现金 BECAUSE 弹性

---

### 4.3 集中 vs 分散
**问题**：该集中持股还是分散？

| 集中派 | 分散派 | 选择依据 |
|--------|--------|----------|
| Warren Buffett | Ray Dalio | 确信度高 → 集中 |
| Stanley Druckenmiller | | 确信度低 → 分散 |

**决策规则**：
- IF 确信度极高（能力圈内 + 深度研究）THEN 集中 BECAUSE 分散是无知的保护
- IF 确信度一般 OR 宏观不确定 THEN 分散 BECAUSE 降低单一风险
- IF 资金规模大 THEN 必须分散 BECAUSE 流动性限制

---

### 4.4 仓位管理
**问题**：确信度和仓位该如何匹配？

| 优先参考 | 次要参考 | 核心问题 |
|----------|----------|----------|
| Stanley Druckenmiller | George Soros | 方向确信度有多高？ |

**决策规则**：
- IF 确信度 90%+ THEN 重仓（10-25%）BECAUSE 看对方向要敢下注
- IF 确信度 60-70% THEN 中等仓位（3-7%）BECAUSE 需要空间调整
- IF 确信度 < 50% THEN 小仓位或不做 BECAUSE 还没想清楚

---

## 五、特殊策略

### 5.1 困境债
| 优先参考 | 核心问题 |
|----------|----------|
| Seth Klarman, Howard Marks | 清算价值？回收率？优先顺序？ |

### 5.2 并购套利
| 优先参考 | 核心问题 |
|----------|----------|
| Seth Klarman | 交易完成概率？价差 vs 风险？ |

### 5.3 分拆套利
| 优先参考 | 核心问题 |
|----------|----------|
| Peter Lynch, Seth Klarman | 子公司被低估吗？被动抛售压力？ |

### 5.4 股东行动主义
| 优先参考 | 核心问题 |
|----------|----------|
| Carl Icahn | 有解锁价值空间吗？管理层可被影响吗？ |

### 5.5 做空泡沫
| 优先参考 | 核心问题 |
|----------|----------|
| Michael Burry, George Soros | 时机？借券成本？止损设定？ |

### 5.6 量化策略
| 优先参考 | 核心问题 |
|----------|----------|
| James Simons | 数据品质？过拟合？容量上限？ |

### 5.7 宏观对冲
| 优先参考 | 核心问题 |
|----------|----------|
| George Soros, Stanley Druckenmiller | 失衡点在哪？催化剂？ |

---

## 六、快速路由表

| 你在问什么？ | 第一优先 | 第二优先 | 第三优先 |
|-------------|---------|---------|---------|
| 这股票值得买吗 | Warren Buffett | Charlie Munger | Peter Lynch |
| 现在该加仓还是减仓 | Howard Marks | Stanley Druckenmiller | Ray Dalio |
| 市场是不是泡沫 | Charlie Munger | Michael Burry | Howard Marks |
| 该持有多少现金 | Seth Klarman | Howard Marks | Warren Buffett |
| 周期在哪个位置 | Ray Dalio | Howard Marks | - |
| 流动性怎么样 | Stanley Druckenmiller | Ray Dalio | - |
| 我的决策有偏误吗 | Charlie Munger | - | - |
| 该如何做资产配置 | Ray Dalio | - | - |
| 这是价值陷阱吗 | Charlie Munger | Seth Klarman | - |
| 该不该止损 | George Soros | Stanley Druckenmiller | - |
| 如何评估护城河 | Warren Buffett | Charlie Munger | - |
| PEG 怎么用 | Peter Lynch | - | - |
| 困境债怎么投 | Seth Klarman | Howard Marks | - |
| 如何做宏观交易 | Stanley Druckenmiller | George Soros | - |

---

## 七、决策工作流（完整流程）

```
1. 宏觀定位 → 參考 Ray Dalio / Stanley Druckenmiller
   └→ 當前經濟象限？流動性趨勢？

2. 週期判斷 → 參考 Howard Marks
   └→ 市場情緒？信用週期？該進攻還是防守？

3. 標的篩選 → 參考 Warren Buffett / Peter Lynch / Seth Klarman
   └→ 護城河？估值？安全邊際？

4. 決策品質檢查 → 參考 Charlie Munger
   └→ 有偏誤嗎？論點夠簡單清晰嗎？

5. 倉位與風控 → 參考 Stanley Druckenmiller / George Soros
   └→ 確信度 vs 倉位？止損點？
```

---

> **使用提示**：
> - 找到对应问题类型 → 查看优先参考的投资人 → 阅读其详细文档
> - 决策规则采用 IF-THEN 格式，可直接用于判断
> - 复杂决策建议交叉参考多位投资人观点

---

## 八、关键词自动匹配表

以下关键词可用于自动识别问题类型：

| 类别 | 关键词（正则） | 路由投资人 |
|------|--------------|-----------|
| **估值** | `估值\|值不值\|贵不贵\|便宜\|低估\|高估\|PE\|PB\|PEG` | Buffett, Klarman, Lynch |
| **护城河** | `护城河\|竞争优势\|壁垒\|moat\|品牌` | Buffett, Munger |
| **宏观** | `宏观\|周期\|经济\|GDP\|通胀\|利率\|Fed` | Dalio, Druckenmiller, Marks |
| **流动性** | `流动性\|QE\|QT\|缩表\|资产负债表\|TGA\|RRP` | Druckenmiller |
| **风险** | `风险\|泡沫\|崩盘\|危机\|做空\|黑天鹅` | Burry, Marks, Munger |
| **心理** | `偏误\|心理\|FOMO\|从众\|贪婪\|恐惧` | Munger |
| **仓位** | `仓位\|加仓\|减仓\|止损\|凯利\|Kelly` | Druckenmiller, Thorp |
| **成长股** | `成长股\|PEG\|增速\|十倍股\|tenbagger` | Lynch |
| **量化** | `量化\|因子\|统计\|回测\|alpha\|夏普` | Simons, Asness, Thorp |
| **加密** | `BTC\|ETH\|加密\|币\|链上\|DeFi` | prompts/crypto_trader |

---

## 九、程序调用示例

### 机器可读配置

完整配置文件：[router_config.yaml](./router_config.yaml)

### Python 路由函数

```python
import re
import yaml
from pathlib import Path

def load_router_config():
    """加载路由配置"""
    config_path = Path(__file__).parent / "router_config.yaml"
    with open(config_path, encoding="utf-8") as f:
        return yaml.safe_load(f)

def route_query(query: str, config: dict = None) -> dict:
    """
    根据问题自动路由到相关投资人
    
    Args:
        query: 用户问题
        config: 路由配置（可选，默认自动加载）
    
    Returns:
        {
            "matched_category": "valuation",
            "primary_investors": ["warren_buffett", "seth_klarman"],
            "secondary_investors": ["peter_lynch"],
            "confidence": 0.85,
            "matched_keywords": ["估值", "便宜"]
        }
    """
    if config is None:
        config = load_router_config()
    
    query_lower = query.lower()
    results = []
    
    # 遍历关键词模式
    for category, pattern_config in config.get("keyword_patterns", {}).items():
        pattern = pattern_config["pattern"]
        investors = pattern_config["investors"]
        weight = pattern_config.get("weight", 0.8)
        
        # 查找匹配的关键词
        matches = re.findall(pattern, query, re.IGNORECASE)
        if matches:
            results.append({
                "category": category,
                "investors": investors,
                "weight": weight,
                "matches": matches,
                "score": len(matches) * weight
            })
    
    if not results:
        # 无匹配，返回默认
        return {
            "matched_category": "default",
            "primary_investors": config.get("default_investors", []),
            "secondary_investors": [],
            "confidence": 0.0,
            "matched_keywords": []
        }
    
    # 按分数排序
    results.sort(key=lambda x: x["score"], reverse=True)
    best = results[0]
    
    return {
        "matched_category": best["category"],
        "primary_investors": best["investors"][:2],
        "secondary_investors": best["investors"][2:] if len(best["investors"]) > 2 else [],
        "confidence": min(best["score"] / 3, 1.0),
        "matched_keywords": best["matches"]
    }

def get_investor_docs(investors: list, base_path: Path = None) -> str:
    """加载投资人文档内容"""
    if base_path is None:
        base_path = Path(__file__).parent
    
    docs = []
    for inv in investors:
        doc_path = base_path / f"{inv}.md"
        if doc_path.exists():
            docs.append(doc_path.read_text(encoding="utf-8"))
    
    return "\n\n---\n\n".join(docs)

# ========== 使用示例 ==========
if __name__ == "__main__":
    # 测试路由
    test_queries = [
        "这只股票的护城河稳不稳？",
        "现在流动性环境怎么样？",
        "BTC 60000 美元值得买吗？",
        "我是不是有 FOMO 了？",
        "仓位应该多大？"
    ]
    
    config = load_router_config()
    
    for q in test_queries:
        result = route_query(q, config)
        print(f"\n问题: {q}")
        print(f"  类别: {result['matched_category']}")
        print(f"  主要参考: {result['primary_investors']}")
        print(f"  置信度: {result['confidence']:.2f}")
```

### Go 调用示例（NOFX 集成）

```go
package knowledge

import (
    "encoding/json"
    "net/http"
    "bytes"
)

type RouteResult struct {
    Category   string   `json:"matched_category"`
    Primary    []string `json:"primary_investors"`
    Secondary  []string `json:"secondary_investors"`
    Confidence float64  `json:"confidence"`
    Keywords   []string `json:"matched_keywords"`
}

// RouteQuery 调用 Python 路由服务
func RouteQuery(query string) (*RouteResult, error) {
    payload := map[string]string{"query": query}
    body, _ := json.Marshal(payload)
    
    resp, err := http.Post(
        "http://localhost:8000/api/v1/route",
        "application/json",
        bytes.NewBuffer(body),
    )
    if err != nil {
        return nil, err
    }
    defer resp.Body.Close()
    
    var result RouteResult
    json.NewDecoder(resp.Body).Decode(&result)
    return &result, nil
}

// 在 NOFX AI 决策中使用
func (ai *AIEngine) EnhanceDecision(query string) string {
    // 1. 路由到相关投资人
    route, _ := RouteQuery(query)
    
    // 2. 加载对应文档
    docs := LoadInvestorDocs(route.Primary)
    
    // 3. 构建增强 prompt
    enhancedPrompt := fmt.Sprintf(`
基于以下投资大师框架回答问题：

%s

用户问题：%s

请用 IF-THEN 规则格式回答。
`, docs, query)
    
    return enhancedPrompt
}
```

